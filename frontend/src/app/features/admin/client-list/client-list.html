<div class="page-container">

  <div class="header">
    <div class="header-left">
      <button mat-icon-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h1>
        <mat-icon>business</mat-icon>
        All Clients
      </h1>
      <span class="client-count"
        >{{ filteredClients.length }} client{{ filteredClients.length !== 1 ? 's' : '' }}</span
      >
    </div>
    <div class="header-actions">
      <button
        mat-stroked-button
        (click)="toggleFilters()"
        [class.active]="showFilters"
        [matBadge]="activeFilterCount"
        [matBadgeHidden]="activeFilterCount === 0"
        matBadgeColor="accent"
        matBadgeSize="small"
      >
        <mat-icon>{{ showFilters ? 'filter_list_off' : 'filter_list' }}</mat-icon>
        Filters
      </button>
    </div>
  </div>

  <div class="filter-section" *ngIf="showFilters">
    <mat-card class="filter-card">
      <div class="filter-content">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Search by name</mat-label>
          <input
            matInput
            [(ngModel)]="searchName"
            (ngModelChange)="applyFilters()"
            placeholder="Company name"
          />
          <mat-icon matPrefix>search</mat-icon>
          <button
            matSuffix
            mat-icon-button
            *ngIf="searchName"
            (click)="searchName = ''; applyFilters()"
            matTooltip="Clear"
          >
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>

               <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Industry</mat-label>
          <mat-select [(ngModel)]="selectedIndustry" (ngModelChange)="applyFilters()">
            <mat-option value="">All Industries</mat-option>
            <mat-option *ngFor="let industry of industries" [value]="industry">
              {{ industry }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>category</mat-icon>
        </mat-form-field>

        
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Document Status</mat-label>
          <mat-select [(ngModel)]="selectedDocStatus" (ngModelChange)="applyFilters()">
            <mat-option value="">All Status</mat-option>
            <mat-option value="submitted">Submitted</mat-option>
            <mat-option value="pending">Pending</mat-option>
          </mat-select>
          <mat-icon matPrefix>description</mat-icon>
        </mat-form-field>

        <button
          mat-button
          class="clear-btn"
          (click)="clearFilters()"
          [disabled]="activeFilterCount === 0"
        >
          <mat-icon>clear_all</mat-icon>
          Clear All
        </button>
      </div>

          <div class="active-filters" *ngIf="activeFilterCount > 0">
        <span class="filter-label">Active filters: </span>
        <mat-chip-set>
          <mat-chip *ngIf="searchName" (removed)="searchName = ''; applyFilters()">
            Name: {{ searchName }}
            <button matChipRemove>
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip>
          <mat-chip *ngIf="selectedIndustry" (removed)="selectedIndustry = ''; applyFilters()">
            Industry: {{ selectedIndustry }}
            <button matChipRemove>
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip>
          <mat-chip *ngIf="selectedDocStatus" (removed)="selectedDocStatus = ''; applyFilters()">
            Status: {{ selectedDocStatus === 'submitted' ? 'Submitted' : 'Pending' }}
            <button matChipRemove>
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip>
        </mat-chip-set>
      </div>
    </mat-card>
  </div>

  
  <div class="error-box" *ngIf="errorMessage">
    <mat-icon>error</mat-icon>
    <span>{{ errorMessage }}</span>
    <button mat-button (click)="loadClients()">
      <mat-icon>refresh</mat-icon>
      Retry
    </button>
  </div>

  <div class="loading" *ngIf="isLoading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading clients...</p>
  </div>


  <mat-card class="no-results" *ngIf="!isLoading && filteredClients.length === 0 && !errorMessage">
    <mat-icon>info</mat-icon>
    <h3>No clients found</h3>
    <p *ngIf="activeFilterCount > 0">Try adjusting your filters</p>
    <p *ngIf="activeFilterCount === 0">No clients have been added yet</p>
  </mat-card>

  <mat-card class="table-card" *ngIf="!isLoading && filteredClients.length > 0">
    <div class="table-wrapper">
      <table mat-table [dataSource]="filteredClients" class="clients-table">
        <ng-container matColumnDef="companyName">
          <th mat-header-cell *matHeaderCellDef>Company</th>
          <td mat-cell *matCellDef="let client">
            <div class="company-cell">
              <mat-icon class="company-icon">business</mat-icon>
              <div>
                <div class="company-name">{{ client.companyName }}</div>
                <div class="company-address">{{ client.address | slice : 0 : 50 }}...</div>
              </div>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="industry">
          <th mat-header-cell *matHeaderCellDef>Industry</th>
          <td mat-cell *matCellDef="let client">
            <mat-chip class="industry-chip">{{ client.industry }}</mat-chip>
          </td>
        </ng-container>


        <ng-container matColumnDef="contact">
          <th mat-header-cell *matHeaderCellDef>Contact</th>
          <td mat-cell *matCellDef="let client">
            <div class="contact-cell">
              <div class="contact-name">{{ client.primaryContact.name }}</div>
              <div class="contact-info">
                <mat-icon>email</mat-icon>
                {{ client.primaryContact.email }}
              </div>
              <div class="contact-info">
                <mat-icon>phone</mat-icon>
                {{ client.primaryContact.phone }}
              </div>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="turnover">
          <th mat-header-cell *matHeaderCellDef>Turnover</th>
          <td mat-cell *matCellDef="let client">
            <div class="turnover-cell">
              <span class="currency">â‚¹</span>
              <span class="amount">{{ client.annualTurnover | number : '1.1-1' }}</span>
              <span class="unit">Cr</span>
            </div>
          </td>
        </ng-container>

            <ng-container matColumnDef="documents">
          <th mat-header-cell *matHeaderCellDef>Documents</th>
          <td mat-cell *matCellDef="let client">
            <mat-chip
              [class.submitted]="client.documentsSubmitted"
              [class.pending]="!client.documentsSubmitted"
            >
              <mat-icon>{{ client.documentsSubmitted ? 'check_circle' : 'pending' }}</mat-icon>
              {{ client.documentsSubmitted ? 'Submitted' : 'Pending' }}
            </mat-chip>
          </td>
        </ng-container>
        <ng-container matColumnDef="rm">
          <th mat-header-cell *matHeaderCellDef>Assigned RM</th>
          <td mat-cell *matCellDef="let client">
            <div class="rm-cell" *ngIf="client.rmId">
              <mat-icon>person</mat-icon>
                         <span matTooltip="{{ client.rmId }}"> RM-{{ client.rmId| slice : 0 : 8 }} </span>
            </div>
            <span class="not-assigned" *ngIf="!client.rmId">Not Assigned</span>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns" class="table-row"></tr>
      </table>
    </div>
  </mat-card>
</div>
