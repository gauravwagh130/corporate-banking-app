<div class="page-container">

  <!-- Header -->
  <div class="header">
    <button mat-icon-button (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>New Credit Request</h1>
    <div class="header-actions">
      <button mat-button (click)="resetForm()" [disabled]="isLoading">
        <mat-icon>refresh</mat-icon>
        Reset
      </button>
    </div>
  </div>

  <!-- Success Message -->
  <div class="success-box" *ngIf="successMessage">
    <mat-icon>check_circle</mat-icon>
    <span>{{ successMessage }}</span>
  </div>

  <!-- Error Message -->
  <div class="error-box" *ngIf="errorMessage">
    <mat-icon>error</mat-icon>
    <span>{{ errorMessage }}</span>
    <button mat-icon-button (click)="errorMessage = ''">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Form Card -->
  <mat-card class="form-card">
    <form [formGroup]="requestForm" (ngSubmit)="onSubmit()">
      
      <!-- Client Selection Section -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon>business</mat-icon>
          <h2>Client Information</h2>
        </div>

        <div class="fields-grid">
          <!-- Client Selection -->
          <mat-form-field appearance="outline" class="span-3">
            <mat-label>Select Client *</mat-label>
            <mat-select formControlName="clientId">
              <mat-option *ngIf="isLoadingClients" disabled>Loading clients...</mat-option>
              <mat-option *ngFor="let client of clients" [value]="client.id">
                {{ client.companyName }} - {{ client.industry }}
              </mat-option>
              <mat-option *ngIf="!isLoadingClients && clients.length === 0" disabled>
                No clients with submitted documents found
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>business</mat-icon>
            <mat-hint>Only clients with submitted documents are shown</mat-hint>
            <mat-error>Client selection is required</mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Credit Request Details Section -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon>request_quote</mat-icon>
          <h2>Credit Request Details</h2>
        </div>

        <div class="fields-grid">
          <!-- Request Amount -->
          <mat-form-field appearance="outline">
            <mat-label>Request Amount (in Crores) *</mat-label>
            <input matInput type="number" step="0.1" formControlName="requestAmount" placeholder="5. 0">
            <span matPrefix>₹&nbsp;</span>
            <span matSuffix>&nbsp;Cr</span>
            <mat-hint>Amount must be greater than 0</mat-hint>
            <mat-error *ngIf="requestForm.get('requestAmount')?.hasError('required')">
              Request amount is required
            </mat-error>
            <mat-error *ngIf="requestForm. get('requestAmount')?.hasError('min')">
              Amount must be greater than 0
            </mat-error>
          </mat-form-field>

          <!-- Tenure -->
          <mat-form-field appearance="outline">
            <mat-label>Tenure (Months) *</mat-label>
            <mat-select formControlName="tenureMonths">
              <mat-option *ngFor="let tenure of tenureOptions" [value]="tenure">
                {{ tenure }} Months
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>schedule</mat-icon>
            <mat-hint>Select repayment period</mat-hint>
            <mat-error>Tenure is required</mat-error>
          </mat-form-field>

          <!-- Purpose Dropdown -->
          <mat-form-field appearance="outline">
            <mat-label>Purpose Category *</mat-label>
            <mat-select formControlName="purpose">
              <mat-option *ngFor="let option of purposeOptions" [value]="option">
                {{ option }}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>description</mat-icon>
            <mat-hint>Select primary purpose</mat-hint>
            <mat-error>Purpose is required</mat-error>
          </mat-form-field>

          <!-- Purpose Details (if "Other" or additional details) -->
          <mat-form-field appearance="outline" class="span-3" *ngIf="requestForm.get('purpose')?.value === 'Other'">
            <mat-label>Purpose Details *</mat-label>
            <textarea matInput formControlName="purpose" rows="3" 
                      placeholder="Provide detailed purpose for the credit request (minimum 10 characters)"></textarea>
            <mat-icon matPrefix>edit_note</mat-icon>
            <mat-hint>Minimum 10 characters required</mat-hint>
            <mat-error *ngIf="requestForm. get('purpose')?.hasError('required')">
              Purpose details are required
            </mat-error>
            <mat-error *ngIf="requestForm.get('purpose')?.hasError('minlength')">
              Purpose must be at least 10 characters
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Summary Section -->
      <div class="form-summary" *ngIf="requestForm. valid">
        <div class="summary-header">
          <mat-icon>summarize</mat-icon>
          <span>Request Summary</span>
        </div>
        <div class="summary-content">
          <div class="summary-item">
            <span class="label">Client:</span>
            <span class="value">{{ getClientName(requestForm.get('clientId')?.value) }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Amount:</span>
            <span class="value">₹{{ requestForm.get('requestAmount')?.value | number:'1.1-1' }} Crores</span>
          </div>
          <div class="summary-item">
            <span class="label">Tenure: </span>
            <span class="value">{{ requestForm.get('tenureMonths')?.value }} Months</span>
          </div>
          <div class="summary-item">
            <span class="label">Purpose:</span>
            <span class="value">{{ requestForm.get('purpose')?.value }}</span>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button mat-stroked-button type="button" (click)="goBack()" [disabled]="isLoading">
          <mat-icon>close</mat-icon>
          Cancel
        </button>
        <button mat-stroked-button type="button" (click)="resetForm()" [disabled]="isLoading">
          <mat-icon>refresh</mat-icon>
          Reset Form
        </button>
        <button mat-raised-button color="primary" type="submit" [disabled]="isLoading || requestForm.invalid">
          <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
          <mat-icon *ngIf="!isLoading">send</mat-icon>
          <span *ngIf="! isLoading">Submit Request</span>
        </button>
      </div>

    </form>
  </mat-card>

</div>